
//
//  KBOCrawler.swift
//  KBOPeeker
//
//  Created by ÎÇòÏú§ÏßÄ on 3/21/25.
//
import Foundation
import WebKit
import SwiftSoup
import UserNotifications
import Combine

class KBOCrawler: NSObject, WKNavigationDelegate {
    private var gameURL: String
    private var webView: WKWebView?
    private var timer: Timer?
    private var previousBatterName: String?
    private var previousMyScore: Int?
    private var previousOpponentScore: Int?

    private let gameState = GameStateModel.shared
    
    var onTeamDetected: ((_ isHome: Bool, _ opponent: String) -> Void)?
    var onEventDetected: ((_ eventText: String) -> Void)?

    init(gameURL: String) {
        self.gameURL = gameURL
    }

    func start() {
        let config = WKWebViewConfiguration()
        webView = WKWebView(frame: .zero, configuration: config)
        webView?.navigationDelegate = self

        if let url = URL(string: gameURL) {
            webView?.load(URLRequest(url: url))
        }

        timer = Timer.scheduledTimer(withTimeInterval: 5, repeats: true) { [weak self] _ in
            self?.webView?.reload()
        }
    }

    func stop() {
        timer?.invalidate()
        timer = nil
        webView?.navigationDelegate = nil
        webView = nil
    }

    func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            webView.evaluateJavaScript("document.body.innerHTML") { [weak self] result, error in
                guard let self = self else { return }
                if let html = result as? String {
                    self.parseHTML(html)
                } else {
                    print("HTML Ï∂îÏ∂ú Ïã§Ìå®: \(error?.localizedDescription ?? "")")
                }
            }
        }
    }

    private func parseHTML(_ html: String) {
        do {
            let doc = try SwiftSoup.parse(html)

            guard let selectedTeam = UserDefaults.standard.string(forKey: "selectedTeam") else { return }
            gameState.selectedTeamName = selectedTeam

            let team1 = try doc.select("div.info_team.team_vs1 span.tit_team").first()?.text() ?? ""
            let team2 = try doc.select("div.info_team.team_vs2 span.tit_team").first()?.text() ?? ""
            
            let gameInfos = try doc.select("dl.list_gameinfo")
            for info in gameInfos {
                let dt = try info.select("dt").text()
                if dt.contains("Í≤ΩÍ∏∞Ïû•Î™Ö") {
                    let stadium = try info.select("dd").text()
                    gameState.stadiumName = stadium
                    print("Í≤ΩÍ∏∞Ïû•Î™Ö: \(stadium)")
                    break
                }
            }

            
            let isHome: Bool
            if team1 == selectedTeam {
                isHome = false
            } else if team2 == selectedTeam {
                isHome = true
            } else {
                print("‚ö†Ô∏è selectedTeamÏù¥ team1/team2 Ïñ¥ÎîîÏóêÎèÑ ÏóÜÏùå")
                return
            }
            gameState.opponentTeamName = isHome ? team1 : team2
            gameState.isHome = isHome
            self.onTeamDetected?(isHome, gameState.opponentTeamName)

            let score1 = Int(try doc.select("div.info_team.team_vs1 span.num_team").first()?.text() ?? "") ?? 0
            let score2 = Int(try doc.select("div.info_team.team_vs2 span.num_team").first()?.text() ?? "") ?? 0

            let previousMyScoreValue = gameState.teamScores[selectedTeam] ?? 0
            let previousOpponentScoreValue = gameState.teamScores[gameState.opponentTeamName] ?? 0
            
            gameState.teamScores[team1] = score1
            gameState.teamScores[team2] = score2
            UserDefaults.standard.set(false, forKey: "teamChanged")

            let scoreDiv = try doc.select("div.score").first()

            let previousOutCount = gameState.outCount
            
            // Î≥º (Ï≤´ Î≤àÏß∏ <span>)
            let ballText = try scoreDiv?.select("span").get(0).text() ?? "0"
            let ballCount = Int(ballText) ?? 0

            // Ïä§Ìä∏ÎùºÏù¥ÌÅ¨ (Îëê Î≤àÏß∏ <span>)
            let strikeText = try scoreDiv?.select("span").get(1).text() ?? "0"
            let strikeCount = Int(strikeText) ?? 0

            // ÏïÑÏõÉ Ïπ¥Ïö¥Ìä∏ (class="out-num")
            let outText = try scoreDiv?.select("span.out-num").first()?.text() ?? "0"
            let outCount = Int(outText) ?? 0
            
            var currentBatterEventLine: String? = nil
            var isOurTeamAtBat = false

            gameState.updateBSO(ball: ballCount, strike: strikeCount, out: outCount)


            // Determine highest priority event
            var highestPriorityEvent: String?

            if let setting = AppDelegate.instance?.viewModel {
                print("trackOut ÏÑ§Ï†ï: \(setting.trackOut)")
                print("isOurTeamAtBat: \(isOurTeamAtBat), outCount: \(outCount), previousOutCount: \(previousOutCount)")
                
                // Ïã§Ï†êÏùÄ Î≥ÑÎèÑÎ°ú Ï≤òÎ¶¨ (Ïö∞Î¶¨ÌåÄ ÏàòÎπÑ Ï§ëÏóêÎßå Î∞úÏÉùÌïòÎØÄÎ°ú Í≤πÏπòÏßÄ ÏïäÏùå)
                if setting.trackPointLoss && scoreForTeam(gameState.opponentTeamName) > previousOpponentScoreValue {
                    let event = "Ïã§Ï†ê! \(scoreForTeam(gameState.opponentTeamName))Ï†ê"
                    print("üêõ AppDelegateÏóê Ï†ÑÎã¨Îê† eventText: \(event)")
                    self.onEventDetected?(event)
                }

                // ÌôàÎü∞, ÎìùÏ†ê, ÏïàÌÉÄ, ÏïÑÏõÉ Ïö∞ÏÑ†ÏàúÏúÑ ÌåêÎã®
                if let lastEvent = currentBatterEventLine {
                    if setting.trackHomeRun && lastEvent.contains("ÌôàÎü∞") {
                        highestPriorityEvent = "ÌôàÎü∞! \(lastEvent)"
                    } else if setting.trackScore && lastEvent.contains("ÌôàÏù∏") {
                        highestPriorityEvent = "ÎìùÏ†ê! \(lastEvent)"
                    } else if setting.trackHit && lastEvent.contains("Î£®ÌÉÄ") {
                        highestPriorityEvent = "ÏïàÌÉÄ Î∞úÏÉù: \(lastEvent)"
                    }
                }

                if setting.trackOut && isOurTeamAtBat && outCount > previousOutCount {
                    if highestPriorityEvent == nil {
                        highestPriorityEvent = "ÏïÑÏõÉ"
                    }
                }

                // ÏµúÏ¢Ö Ïù¥Î≤§Ìä∏ Ïã§Ìñâ
                if let finalEvent = highestPriorityEvent {
                    print("üêõ AppDelegateÏóê Ï†ÑÎã¨Îê† eventText: \(finalEvent)")
                    self.onEventDetected?(finalEvent)
                }
            }

            gameState.currentInning = try doc.select("span.txt_status").first()?.text() ?? ""

            print("ÏùëÏõêÌåÄ: \(gameState.selectedTeamName), ÏÉÅÎåÄÌåÄ: \(gameState.opponentTeamName)")
            print("Ïä§ÏΩîÏñ¥ - \(team1): \(score1), \(team2): \(score2)")
            print("ÌòÑÏû¨ Ïù¥Îãù: \(gameState.currentInning)")
            
            if let selected = UserDefaults.standard.string(forKey: "selectedTeam") {
                if team1 == selected {
                    self.onTeamDetected?(false, gameState.opponentTeamName)
                } else if team2 == selected {
                    self.onTeamDetected?(true, gameState.opponentTeamName)
                } else {
                    print("‚ö†Ô∏è selectedTeamÏù¥ team1/team2 Ïñ¥ÎîîÏóêÎèÑ ÏóÜÏùå (Îëê Î≤àÏß∏ ÌåêÎ≥Ñ)")
                }
            }

            if gameState.currentInning.contains("Í≤ΩÍ∏∞Ï¢ÖÎ£å") {
                print("Í≤ΩÍ∏∞Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.")
                self.stop()
                return
            }
            
//            if gameState.currentInning.contains("Í≤ΩÍ∏∞ Ï†Ñ") {
//                print("Í≤ΩÍ∏∞ ÏãúÏûë Ï†ÑÏûÖÎãàÎã§.")
//                self.stop()
//                return
//            }
            
            if !(gameState.currentInning.contains("Í≤ΩÍ∏∞Ï¢ÖÎ£å") || gameState.currentInning.contains("Í≤ΩÍ∏∞Ï∑®ÏÜå") || gameState.currentInning.contains("Í≤ΩÍ∏∞ Ï†Ñ")) {
                let inningElement = try doc.select("div.inning").first()

                let topClass = try inningElement?.select("div.triangle-top").first()?.className() ?? ""
                let isTopInning = topClass.contains("on")
                
                let inningText = try inningElement?.select("p").first()?.text() ?? "1"
                let inningNumber = Int(inningText) ?? 1

                print("isTopInning: \(isTopInning), inningNumber: \(inningNumber)")
                
                gameState.updateInning(isTop: isTopInning, number: inningNumber)
                
                // ÌòÑÏû¨ Í≥µÍ≤© Ï§ëÏù∏ ÌåÄ ÌåêÎ≥Ñ
                let teamSpans = try doc.select("div.scorebox_team span.txt_team")
                guard teamSpans.count >= 2 else { return }

                let awayTeam = try teamSpans.get(0).text()
                let homeTeam = try teamSpans.get(1).text()

                let currentAttackingTeam = gameState.isTopInning ? awayTeam : homeTeam
                print("awayTeam: \(awayTeam), homeTeam: \(homeTeam)")
                print("selectedTeamName: \(gameState.selectedTeamName)")
                print("currentAttackingTeam: \(currentAttackingTeam)")
                isOurTeamAtBat = (currentAttackingTeam == gameState.selectedTeamName)
                if let setting = AppDelegate.instance?.viewModel,
                   setting.trackOut,
                   isOurTeamAtBat,
                   outCount > previousOutCount {
                    print("‚úÖ ÏïÑÏõÉÏπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä Í∞êÏßÄÎê®: \(previousOutCount) ‚Üí \(outCount)")
                    self.onEventDetected?("ÏïÑÏõÉ")
                }

                print("ÌòÑÏû¨ Í≥µÍ≤© ÌåÄ: \(currentAttackingTeam) / Ïö∞Î¶¨ ÌåÄ Í≥µÍ≤© Ï§ë? \(isOurTeamAtBat)")

                // ÌòÑÏû¨ ÌÉÄÏûê Ïù¥Î¶Ñ ÌååÏã±
                let batterNameElement = try doc.select("div.combo_history div.info_profile strong.txt_player").first()
                let currentBatterName = try batterNameElement?.text() ?? ""

                var batterChanged = false
                print(currentBatterName)
                if let previous = previousBatterName, previous != currentBatterName {
                    batterChanged = true
                }
                previousBatterName = currentBatterName

                // Ï†ÑÏ≤¥ Ïù¥Î≤§Ìä∏ Î∏îÎ°ùÏóêÏÑú ÌòÑÏû¨ ÌÉÄÏûêÏùò Ïù¥Î≤§Ìä∏ Ï§ÑÎßå Ï∂îÏ∂ú
                print("üéØ currentBatterName: \(currentBatterName)")
                let historyDivs = try doc.select("div.combo_history")

                for div in historyDivs {
                    let name = try div.select("strong.txt_player").text()
                    if name == currentBatterName {
                        let lines = try div.select("div.item_history span.txt_g")
//                        for line in lines {
//                            let lineText = try line.text()
//                            print("üìå div ÌÖçÏä§Ìä∏: \(lineText)")
//                            if lineText.contains(currentBatterName) {
//                                print("üëâ ÌòÑÏû¨ ÌÉÄÏûê Ïù¥Î≤§Ìä∏ ÎùºÏù∏: \(lineText)")
//                                currentBatterEventLine = lineText
//                                break
//                            }
//                        }
                        for line in lines.reversed() {
                            let lineText = try line.text()
                            print("üìå div ÌÖçÏä§Ìä∏: \(lineText)")
                            currentBatterEventLine = lineText
                            break
                        }
                        break
                    }
                }

                // ÌòÑÏû¨ ÌÉÄÏûê Ïù¥Î≤§Ìä∏ Ï§ÑÎ°ú Í∞êÏßÄ
                if let lastEvent = currentBatterEventLine {
                    print("ÏµúÍ∑º Ïù¥Î≤§Ìä∏: \(lastEvent)")
                }

                // 1Î£®/2Î£®/3Î£® Î≤†Ïù¥Ïä§ Ï†êÏú† Ïó¨Î∂Ä
                let baseElements = try doc.select("ul.base li")
                for base in baseElements {
                    let className = try base.className()
                    let isOn = className.contains("on")
                    if className.contains("b1") {
                        gameState.isFirstBaseOccupied = isOn
                    } else if className.contains("b2") {
                        gameState.isSecondBaseOccupied = isOn
                    } else if className.contains("b3") {
                        gameState.isThirdBaseOccupied = isOn
                    }
                }

                print("1Î£®: \(gameState.isFirstBaseOccupied), 2Î£®: \(gameState.isSecondBaseOccupied), 3Î£®: \(gameState.isThirdBaseOccupied)")
                print("B/S/O: \(gameState.ballCount)/\(gameState.strikeCount)/\(gameState.outCount)")
            }
            
        } catch {
            print("HTML ÌååÏã± Ïò§Î•ò: \(error)")
        }
    }

    private func scoreForTeam(_ team: String) -> Int {
        return gameState.teamScores[team] ?? 0
    }

    private func sendNotification(title: String, body: String) {
        let content = UNMutableNotificationContent()
        content.title = title
        content.body = body
        let request = UNNotificationRequest(identifier: UUID().uuidString, content: content, trigger: nil)
        UNUserNotificationCenter.current().add(request)
    }
}
